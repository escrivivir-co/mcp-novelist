<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aleph MCP - Cat√°logo de Novelas</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="novel-catalog.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap">
    <meta name="description" content="Explorador de novelas generadas con Aleph MCP">
</head>
<body>
    <div class="stars"></div>
    <div class="twinkling"></div>
    
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo">Œ±</div>
                <h1 class="glitch" data-text="ALEPH NOVELS">ALEPH NOVELS</h1>
            </div>
            <div class="subtitle">Explorador del Multiverso Narrativo</div>
            <nav class="main-nav">
                <a href="index.html">Inicio</a>
                <a href="#" class="active">Cat√°logo</a>
                <a href="DOCUMENTATION.md">Documentaci√≥n</a>
            </nav>
        </header>

        <div class="server-status">
            <div class="status-indicator online" id="server-status-indicator"></div>
            <span id="server-status-text">Conectando al servidor...</span>
        </div>

        <section class="catalog-view" id="catalog-container">
            <div class="view-toggle">
                <button class="toggle-btn active" data-view="novels">Novelas</button>
                <button class="toggle-btn" data-view="characters">Personajes</button>
                <button class="toggle-btn" data-view="scenes">Escenas</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar..." class="search-input">
                <div class="search-icon">‚åï</div>
            </div>

            <div class="catalog-grid" id="catalog-grid">
                <!-- El contenido se cargar√° din√°micamente desde novel-data.json -->
                <div class="loading">
                    <div class="loading-text">Cargando datos del servidor...</div>
                    <div class="spinner"></div>
                </div>
            </div>
        </section>

        <div class="modal" id="detail-modal">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <div class="modal-body" id="modal-content">
                    <!-- El contenido se cargar√° din√°micamente -->
                </div>
            </div>
        </div>

        <section class="cta">
            <a href="https://github.com/tu-usuario/aleph-mcp" class="cta-button">Ver en GitHub</a>
            <a href="index.html" class="cta-button secondary">Volver al Inicio</a>
        </section>
    </div>

    <footer>
        <p>Datos en tiempo real del servidor Aleph MCP - Actualizado: <span id="last-updated">Cargando...</span></p>
        <div class="footer-links">
            <a href="https://github.com/tu-usuario/aleph-mcp">GitHub</a>
            <a href="CONTRIBUTING.md">Contribuir</a>
            <a href="LICENSE">Licencia</a>
        </div>
    </footer>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // Referencias a elementos del DOM
    const catalogGrid = document.getElementById('catalog-grid');
    const serverStatusIndicator = document.getElementById('server-status-indicator');
    const serverStatusText = document.getElementById('server-status-text');
    const lastUpdatedElement = document.getElementById('last-updated');
    const searchInput = document.getElementById('search-input');
    const modal = document.getElementById('detail-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModal = document.querySelector('.close-modal');
    const viewToggleBtns = document.querySelectorAll('.toggle-btn');

    // Estado de la aplicaci√≥n
    let novelData = null;
    let currentView = 'novels';
    let searchTerm = '';

    // Funci√≥n para cargar los datos desde la API
    async function loadNovelData() {
        try {
            console.log("Intentando cargar datos desde:", './api/novel-data.json');
            const response = await fetch('./api/novel-data.json');
            
            if (!response.ok) {
                console.error('Error de respuesta:', response.status, response.statusText);
                throw new Error(`No se pudieron cargar los datos. Estado: ${response.status}`);
            }
            
            // Obtener el texto de la respuesta para depuraci√≥n
            const responseText = await response.text();
            console.log("Texto de respuesta:", responseText.substring(0, 100) + "...");
            
            try {
                // Intentar analizar el texto como JSON
                novelData = JSON.parse(responseText);
                console.log("Datos JSON cargados correctamente:", novelData);
            } catch (jsonError) {
                console.error("Error al analizar JSON:", jsonError);
                throw new Error(`Error al analizar JSON: ${jsonError.message}`);
            }
            
            // Actualizar la fecha de √∫ltima actualizaci√≥n
            const timestamp = new Date();
            lastUpdatedElement.textContent = timestamp.toLocaleString();
            
            // Actualizar el estado del servidor
            serverStatusIndicator.classList.remove('offline');
            serverStatusIndicator.classList.add('online');
            serverStatusText.textContent = 'Servidor MCP conectado';
            
            // Renderizar la vista actual
            renderView();
        } catch (error) {
            console.error('Error al cargar los datos:', error);
            catalogGrid.innerHTML = `
                <div class="error-container">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-message">No se pudieron cargar los datos del servidor: ${error.message}</div>
                    <button class="retry-button" onclick="location.reload()">Reintentar</button>
                </div>
            `;
            serverStatusIndicator.classList.remove('online');
            serverStatusIndicator.classList.add('offline');
            serverStatusText.textContent = 'Servidor MCP desconectado';
        }
    }

    // Funci√≥n para renderizar la vista actual
    function renderView() {
        if (!novelData) return;
        
        let items = [];
        let template = '';
        
        // Filtrar por t√©rmino de b√∫squeda
        const filterItems = (items) => {
            if (!searchTerm) return items;
            return items.filter(item => 
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                item.description.toLowerCase().includes(searchTerm.toLowerCase())
            );
        };
        
        // Determinar qu√© datos mostrar seg√∫n la vista actual
        switch (currentView) {
            case 'novels':
                items = filterItems(novelData.novels || []);
                template = createNovelCard;
                break;
            case 'characters':
                items = filterItems(novelData.characters || []);
                template = createCharacterCard;
                break;
            case 'scenes':
                items = filterItems(novelData.scenes || []);
                template = createSceneCard;
                break;
        }
        
        // Renderizar los items
        if (items.length === 0) {
            catalogGrid.innerHTML = `
                <div class="no-results">
                    <div class="no-results-icon">üîé</div>
                    <div class="no-results-text">No se encontraron resultados para "${searchTerm}"</div>
                </div>
            `;
        } else {
            catalogGrid.innerHTML = items.map(template).join('');
            
            // A√±adir event listeners a las tarjetas
            document.querySelectorAll('.catalog-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const type = e.currentTarget.dataset.type;
                    showDetails(id, type);
                });
            });
        }
    }
    
    // Templates para las tarjetas
    function createNovelCard(novel) {
        // A√±adir verificaci√≥n de propiedades
        const description = novel.description || novel.summary || '';
        const characterCount = novel.characters ? novel.characters.length : 0;
        const chapterCount = novel.chapters ? novel.chapters.length : 0;
        
        return `
            <div class="catalog-card" data-id="${novel.id}" data-type="novel">
                <div class="card-header">
                    <h3>${novel.name || novel.title || 'Sin t√≠tulo'}</h3>
                    <span class="card-badge">${novel.genre || 'General'}</span>
                </div>
                <div class="card-body">
                    <p>${description.substring(0, 150)}${description.length > 150 ? '...' : ''}</p>
                </div>
                <div class="card-footer">
                    <span class="card-meta">${chapterCount} cap√≠tulos</span>
                    <span class="card-meta">${characterCount} personajes</span>
                </div>
            </div>
        `;
    }
    
    function createCharacterCard(character) {
        return `
            <div class="catalog-card" data-id="${character.id}" data-type="character">
                <div class="card-header">
                    <h3>${character.name}</h3>
                    <span class="card-badge">${character.role || 'Personaje'}</span>
                </div>
                <div class="card-body">
                    <p>${character.description.substring(0, 150)}${character.description.length > 150 ? '...' : ''}</p>
                </div>
                <div class="card-footer">
                    <span class="card-meta">${character.traits.join(', ')}</span>
                </div>
            </div>
        `;
    }
    
    function createSceneCard(scene) {
        return `
            <div class="catalog-card" data-id="${scene.id}" data-type="scene">
                <div class="card-header">
                    <h3>${scene.title}</h3>
                    <span class="card-badge">Escena</span>
                </div>
                <div class="card-body">
                    <p>${scene.setting}</p>
                    <p>${scene.content.substring(0, 100)}${scene.content.length > 100 ? '...' : ''}</p>
                </div>
                <div class="card-footer">
                    <span class="card-meta">${scene.characters.length} personajes</span>
                </div>
            </div>
        `;
    }
    
    // Funci√≥n para mostrar los detalles de un item
    function showDetails(id, type) {
        let item = null;
        let detailsHTML = '';
        
        // Encontrar el item correspondiente
        switch (type) {
            case 'novel':
                item = novelData.novels.find(n => n.id === id);
                if (item) {
                    detailsHTML = `
                        <div class="detail-header">
                            <h2>${item.name}</h2>
                            <div class="detail-meta">
                                <span class="detail-badge">${item.genre}</span>
                                <span class="detail-date">Creada: ${new Date().toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>Descripci√≥n</h3>
                            <p>${item.description}</p>
                        </div>
                        <div class="detail-section">
                            <h3>Personajes</h3>
                            <div class="detail-characters">
                                ${item.characters.map(charId => {
                                    const char = novelData.characters.find(c => c.id === charId);
                                    return char ? `
                                        <div class="detail-character-card" data-id="${char.id}" data-type="character">
                                            <h4>${char.name}</h4>
                                            <p>${char.description.substring(0, 100)}...</p>
                                        </div>
                                    ` : '';
                                }).join('')}
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>Cap√≠tulos</h3>
                            <div class="chapters-accordion">
                                ${item.chapters.map(chapter => {
                                    return `
                                        <div class="chapter-item">
                                            <div class="chapter-header">
                                                <h4>${chapter.title}</h4>
                                                <span class="chapter-toggle">+</span>
                                            </div>
                                            <div class="chapter-content">
                                                <p>${chapter.description}</p>
                                                <h5>Escenas:</h5>
                                                <ul class="scene-list">
                                                    ${chapter.scenes.map(sceneId => {
                                                        const scene = novelData.scenes.find(s => s.id === sceneId);
                                                        return scene ? `
                                                            <li>
                                                                <a href="#" class="scene-link" data-id="${scene.id}" data-type="scene">
                                                                    ${scene.title}
                                                                </a>
                                                            </li>
                                                        ` : '';
                                                    }).join('')}
                                                </ul>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
                break;
                
            case 'character':
                item = novelData.characters.find(c => c.id === id);
                if (item) {
                    detailsHTML = `
                        <div class="detail-header">
                            <h2>${item.name}</h2>
                            <div class="detail-meta">
                                <span class="detail-badge">${item.role || 'Personaje'}</span>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>Descripci√≥n</h3>
                            <p>${item.description}</p>
                        </div>
                        <div class="detail-section">
                            <h3>Rasgos</h3>
                            <div class="traits-container">
                                ${item.traits.map(trait => `<span class="trait-badge">${trait}</span>`).join('')}
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>Trasfondo</h3>
                            <p>${item.background}</p>
                        </div>
                        <div class="detail-section">
                            <h3>Aparece en</h3>
                            <div class="appears-in-list">
                                ${novelData.novels
                                    .filter(novel => novel.characters.includes(id))
                                    .map(novel => `
                                        <div class="appears-in-item" data-id="${novel.id}" data-type="novel">
                                            <h4>${novel.name}</h4>
                                            <p>${novel.description.substring(0, 100)}...</p>
                                        </div>
                                    `).join('')}
                            </div>
                        </div>
                    `;
                }
                break;
                
            case 'scene':
                item = novelData.scenes.find(s => s.id === id);
                if (item) {
                    detailsHTML = `
                        <div class="detail-header">
                            <h2>${item.title}</h2>
                            <div class="detail-meta">
                                <span class="detail-badge">Escena</span>
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>Ambientaci√≥n</h3>
                            <p>${item.setting}</p>
                        </div>
                        <div class="detail-section">
                            <h3>Personajes presentes</h3>
                            <div class="present-characters">
                                ${item.characters.map(charId => {
                                    const char = novelData.characters.find(c => c.id === charId);
                                    return char ? `
                                        <span class="character-badge" data-id="${char.id}" data-type="character">
                                            ${char.name}
                                        </span>
                                    ` : '';
                                }).join('')}
                            </div>
                        </div>
                        <div class="detail-section">
                            <h3>Contenido</h3>
                            <div class="scene-content">${item.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    `;
                }
                break;
        }
        
        // Mostrar el modal con los detalles
        if (detailsHTML) {
            modalContent.innerHTML = detailsHTML;
            modal.style.display = 'block';
            
            // A√±adir event listeners a los elementos interactivos dentro del modal
            modalContent.querySelectorAll('[data-id]').forEach(el => {
                el.addEventListener('click', (e) => {
                    e.preventDefault();
                    const newId = e.currentTarget.dataset.id;
                    const newType = e.currentTarget.dataset.type;
                    showDetails(newId, newType);
                });
            });
            
            // Event listeners para el acorde√≥n de cap√≠tulos
            modalContent.querySelectorAll('.chapter-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const chapterItem = e.currentTarget.parentElement;
                    const chapterContent = chapterItem.querySelector('.chapter-content');
                    const toggle = e.currentTarget.querySelector('.chapter-toggle');
                    
                    if (chapterContent.style.maxHeight) {
                        chapterContent.style.maxHeight = null;
                        toggle.textContent = '+';
                    } else {
                        chapterContent.style.maxHeight = chapterContent.scrollHeight + 'px';
                        toggle.textContent = '‚àí';
                    }
                });
            });
        }
    }
    
    // Event listeners
    
    // Cambiar vista
    viewToggleBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
            viewToggleBtns.forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            currentView = e.currentTarget.dataset.view;
            renderView();
        });
    });
    
    // B√∫squeda
    searchInput.addEventListener('input', (e) => {
        searchTerm = e.target.value.trim();
        renderView();
    });
    
    // Cerrar modal
    closeModal.addEventListener('click', () => {
        modal.style.display = 'none';
    });
    
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });
    
    // Iniciar la carga de datos
    loadNovelData();
    
    // Comprobar actualizaciones cada 5 minutos
    setInterval(loadNovelData, 5 * 60 * 1000);
});
    </script>
</body>
</html>
